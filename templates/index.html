<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="manifest" href="/static/manifest.json">
<title>勉強アドバイザーAI</title>
<link rel="stylesheet" href="/static/style.css">
<style>
body { font-family: Arial, sans-serif; background: #f5f5f5; margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; }
.chat-container { display: flex; flex-direction: column; flex: 1; padding: 10px; overflow-y: auto; }
.messages { display: flex; flex-direction: column; gap: 10px; flex: 1; overflow-y: auto; }
.message { max-width: 70%; padding: 10px 15px; border-radius: 20px; word-wrap: break-word; position: relative; }
.user { background-color: #4a90e2; color: white; align-self: flex-end; border-bottom-right-radius: 0; }
.ai { background-color: #e0e0e0; color: black; align-self: flex-start; border-bottom-left-radius: 0; }
.delete-btn { position: absolute; bottom: 2px; left: 2px; background: red; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; display: none; cursor: pointer; font-size: 12px; }
.message.user:hover .delete-btn { display: block; }
.chat-form { display: flex; padding: 10px; gap: 10px; border-top: 1px solid #ccc; background: white; }
.chat-form input { flex: 1; padding: 10px; border-radius: 20px; border: 1px solid #ccc; }
.chat-form button { padding: 10px 20px; border-radius: 20px; border: none; background-color: #4a90e2; color: white; font-weight: bold; cursor: pointer; }
.chat-form button:disabled { background-color: #aaa; cursor: not-allowed; }
.status { text-align: center; font-size: 14px; color: #666; margin-bottom: 5px; display: none; }
</style>
</head>
<body>
<div id="chat-container" class="chat-container">
    <div id="status" class="status">AIが返信中です...</div>
    <div id="messages" class="messages"></div>
    <form id="chat-form" class="chat-form">
        <input type="text" id="chat-input" placeholder="メッセージを入力..." />
        <button type="submit" id="send-button">送信</button>
    </form>
</div>

<script>
const form = document.getElementById("chat-form");
const input = document.getElementById("chat-input");
const messages = document.getElementById("messages");
const sendButton = document.getElementById("send-button");
const status = document.getElementById("status");
let isWaitingForReply = false;
let sessionId = "default-session";

let questionIndex = 0;
const questions = [
    "こんにちは！私はあなたの勉強をサポートします！まずは5つの質問であなたのことを教えてください",
    "あなたのことは何と呼べばいいですか？",
    "了解です！何のための勉強をサポートしてほしいですか？(例: 試験対策、受験勉強など)",
    "なるほど、普段の1日の勉強時間はどのくらいですか？",
    "スマホは１日どれくらい使いますか？",
    "勉強はコツコツやる派ですかそれとも一夜漬けタイプ？"
];

function appendMessage(content, sender, msgId=null) {
    const div = document.createElement("div");
    div.classList.add("message", sender);
    div.textContent = content;
    if(sender === "user") {
        const delBtn = document.createElement("button");
        delBtn.textContent = "×";
        delBtn.className = "delete-btn";
        delBtn.onclick = async () => {
            // 直前メッセージとAI返信削除
            if(messages.lastChild.previousSibling){
                messages.removeChild(messages.lastChild.previousSibling); 
            }
            messages.removeChild(div);
            await fetch(/delete_last/${sessionId}, { method: "DELETE" });
        };
        div.appendChild(delBtn);
    }
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
}

async function askNextQuestion() {
    if(questionIndex < questions.length){
        appendMessage(questions[questionIndex], "ai");
        questionIndex++;
        isWaitingForReply = false;
        sendButton.disabled = false;
    }
}

async function sendMessage(userMessage){
    status.style.display = "block";
    try{
        const response = await fetch("/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message: userMessage, session_id: sessionId })
        });
        const data = await response.json();
        appendMessage(data.response, "ai");
    } catch(err){
        appendMessage("通信エラーが発生しました。", "ai");
    } finally {
        status.style.display = "none";
        isWaitingForReply = false;
        sendButton.disabled = false;
    }
}

// 初回起動時にAIから話しかける
window.onload = () => {
    askNextQuestion();
};

form.addEventListener("submit", async (e)=>{
    e.preventDefault();
    if(isWaitingForReply || !input.value.trim()) return;

    const userMessage = input.value.trim();
    appendMessage(userMessage, "user");
    input.value = "";
    isWaitingForReply = true;
    sendButton.disabled = true;

    if(questionIndex < questions.length){
        // 質問モード
        await fetch("/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message: userMessage, session_id: sessionId })
        });
        askNextQuestion();
    } else {
        // 通常会話モード
        sendMessage(userMessage);
    }
});
</script>
</body>
</html>