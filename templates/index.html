<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>勉強アドバイザーAI</title>
<style>
body { font-family: Arial, sans-serif; background: #f5f5f5; margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; }
.chat-container { display: flex; flex-direction: column; flex: 1; padding: 10px; overflow-y: auto; }
.messages { display: flex; flex-direction: column; gap: 10px; flex: 1; overflow-y: auto; }
.message { max-width: 70%; padding: 10px 15px; border-radius: 20px; word-wrap: break-word; position: relative; }
.user { background-color: #4a90e2; color: white; align-self: flex-end; border-bottom-right-radius: 0; }
.ai { background-color: #e0e0e0; color: black; align-self: flex-start; border-bottom-left-radius: 0; }
.chat-form { display: flex; padding: 10px; gap: 10px; border-top: 1px solid #ccc; background: white; }
.chat-form input { flex: 1; padding: 10px; border-radius: 20px; border: 1px solid #ccc; }
.chat-form button { padding: 10px 20px; border-radius: 20px; border: none; background-color: #4a90e2; color: white; font-weight: bold; cursor: pointer; }
.chat-form button:disabled { background-color: #aaa; cursor: not-allowed; }
.status { text-align: center; font-size: 14px; color: #666; margin-bottom: 5px; display: none; }
</style>
</head>
<body>
<div id="chat-container" class="chat-container">
    <div id="status" class="status">AIが返信中です...</div>
    <div id="messages" class="messages"></div>

    <form id="chat-form" class="chat-form">
        <input type="text" id="chat-input" placeholder="メッセージを入力..." autocomplete="off"/>
        <button type="submit" id="send-button">送信</button>
    </form>

    <div style="padding:10px; background:#fff; border-top:1px solid #ccc;">
        <h4>スクリーンタイム入力</h4>
        <input type="number" id="study-time" placeholder="勉強時間(時間)" step="0.1"/>
        <input type="number" id="sns-time" placeholder="SNS時間(時間)" step="0.1"/>
        <input type="number" id="game-time" placeholder="ゲーム時間(時間)" step="0.1"/>
        <button id="send-screen">送信</button>
    </div>

    <div style="padding:10px; background:#fff; border-top:1px solid #ccc;">
        <h4>スケジュール相談</h4>
        <input type="text" id="schedule-msg" placeholder="希望を入力"/>
        <button id="ask-schedule">相談</button>
    </div>
</div>

<script>
const form = document.getElementById("chat-form");
const input = document.getElementById("chat-input");
const messages = document.getElementById("messages");
const sendButton = document.getElementById("send-button");
const status = document.getElementById("status");

let sessionId = "default-session";
let isWaiting = false;

function appendMessage(content, sender) {
    const div = document.createElement("div");
    div.className = `message ${sender}`;
    div.textContent = content;
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
}

async function loadHistory() {
    try {
        const res = await fetch(`/history/${sessionId}`);
        const data = await res.json();
        data.history.forEach(h => appendMessage(h.content, h.role === "user" ? "user" : "ai"));
    } catch (e) { console.error("履歴取得エラー", e); }
}

async function sendMessage(msg) {
    if (!msg.trim()) return;
    appendMessage(msg, "user");
    input.value = "";
    isWaiting = true;
    sendButton.disabled = true;
    status.style.display = "block";

    try {
        const res = await fetch("/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message: msg, session_id: sessionId })
        });
        const data = await res.json();
        appendMessage(data.response, "ai");
    } catch (e) {
        appendMessage("通信エラーが発生しました。", "ai");
    } finally {
        isWaiting = false;
        sendButton.disabled = false;
        status.style.display = "none";
    }
}

form.addEventListener("submit", (e) => {
    e.preventDefault();
    if (!isWaiting && input.value.trim()) sendMessage(input.value);
});

// --- スクリーンタイム送信 ---
document.getElementById("send-screen").addEventListener("click", async () => {
    const study = parseFloat(document.getElementById("study-time").value) || 0;
    const sns = parseFloat(document.getElementById("sns-time").value) || 0;
    const game = parseFloat(document.getElementById("game-time").value) || 0;

    try {
        await fetch("/screen_time", {
            method: "POST",
            body: new URLSearchParams({ session_id: sessionId, study_time: study, sns_time: sns, game_time: game })
        });
        alert("スクリーンタイムを送信しました！");
    } catch (e) {
        alert("送信エラー");
    }
});

// --- スケジュール相談 ---
document.getElementById("ask-schedule").addEventListener("click", async () => {
    const msg = document.getElementById("schedule-msg").value;
    if (!msg.trim()) return;

    appendMessage(msg, "user");
    document.getElementById("schedule-msg").value = "";

    try {
        const res = await fetch("/plan_schedule", {
            method: "POST",
            body: new URLSearchParams({ session_id: sessionId, message: msg })
        });
        const data = await res.json();
        appendMessage(data.response