<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>勉強アドバイザーAI</title>
<style>
body { font-family: Arial, sans-serif; background: #f5f5f5; margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; }
.chat-container { display: flex; flex-direction: column; flex: 1; padding: 10px; overflow-y: auto; }
.messages { display: flex; flex-direction: column; gap: 10px; flex: 1; overflow-y: auto; }
.message { max-width: 70%; padding: 10px 15px; border-radius: 20px; word-wrap: break-word; position: relative; }
.user { background-color: #4a90e2; color: white; align-self: flex-end; border-bottom-right-radius: 0; }
.ai { background-color: #e0e0e0; color: black; align-self: flex-start; border-bottom-left-radius: 0; }
.chat-form { display: flex; flex-direction: column; padding: 10px; gap: 5px; border-top: 1px solid #ccc; background: white; }
.chat-form input, .chat-form button { padding: 10px; border-radius: 20px; border: 1px solid #ccc; }
.chat-form button { background-color: #4a90e2; color: white; font-weight: bold; cursor: pointer; border: none; }
.chat-form button:disabled { background-color: #aaa; cursor: not-allowed; }
.status { text-align: center; font-size: 14px; color: #666; margin-bottom: 5px; display: none; }
</style>
</head>
<body>
<div id="chat-container" class="chat-container">
    <div id="status" class="status">AIが返信中です...</div>
    <div id="messages" class="messages"></div>
    <form id="chat-form" class="chat-form">
        <input type="text" id="chat-input" placeholder="メッセージを入力..." autocomplete="off"/>
        <input type="number" id="study-time" placeholder="今日の勉強時間(時間)" min="0"/>
        <input type="number" id="phone-time" placeholder="今日のスマホ時間(時間)" min="0"/>
        <button type="submit" id="send-button">送信</button>
    </form>
</div>

<script>
// ===== セッションID 永続化 =====
const SESSION_KEY = "sessionId";
function uuidv4_fallback() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
        const r = Math.random() * 16 | 0;
        const v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
    });
}
function getOrCreateSessionId() {
    let id = localStorage.getItem(SESSION_KEY);
    if (!id) {
        id = (crypto.randomUUID ? crypto.randomUUID() : uuidv4_fallback());
        localStorage.setItem(SESSION_KEY, id);
    }
    return id;
}
let sessionId = getOrCreateSessionId();

// ===== DOM =====
const form = document.getElementById("chat-form");
const input = document.getElementById("chat-input");
const messages = document.getElementById("messages");
const sendButton = document.getElementById("send-button");
const status = document.getElementById("status");
const studyInput = document.getElementById("study-time");
const phoneInput = document.getElementById("phone-time");

let isWaiting = false;

// メッセージ追加
function appendMessage(content, sender) {
    const div = document.createElement("div");
    div.className = `message ${sender}`;
    div.textContent = content;
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
}

// 履歴取得
async function loadHistory() {
    try {
        const res = await fetch(`/history/${sessionId}`);
        if (!res.ok) return [];
        const data = await res.json();
        data.history.forEach(h => appendMessage(h.content, h.role === "user" ? "user" : "ai"));
        return data.history;
    } catch (e) {
        console.error("履歴取得エラー", e);
        return [];
    }
}

// メッセージ送信
async function sendMessage(msg) {
    if (!msg.trim()) return;
    appendMessage(msg, "user");

    const studyTime = studyInput.value ? parseInt(studyInput.value, 10) : 0;
    const phoneTime = phoneInput.value ? parseInt(phoneInput.value, 10) : 0;

    input.value = "";
    studyInput.value = "";
    phoneInput.value = "";

    isWaiting = true;
    sendButton.disabled = true;
    status.style.display = "block";

    try {
        const res = await fetch("/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                message: msg,
                session_id: sessionId,
                study_time: studyTime,
                phone_time: phoneTime
            })
        });

        if (!res.ok) {
            appendMessage("通信エラーが発生しました。", "ai");
            return;
        }

        const data = await res.json();
        appendMessage(data.response, "ai");
    } catch (e) {
        appendMessage("通信エラーが発生しました。", "ai");
    } finally {
        isWaiting = false;
        sendButton.disabled = false;
        status.style.display = "none";
    }
}

// フォーム submit
form.addEventListener("submit", (e) => {
    e.preventDefault();
    if (!isWaiting && input.value.trim()) sendMessage(input.value);
});

// 初期ロード
window.addEventListener("load", async () => {
    const history = await loadHistory();
    if (history.length === 0) {
        // 初回のみ AI が自己紹介を投げる
        appendMessage("初めまして！今日はどんな勉強をする予定？", "ai");
    }
});
</script>
</body>
</html>